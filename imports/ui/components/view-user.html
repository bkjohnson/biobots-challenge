<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../components/view-print.html">
<link rel="import" href="../components/user-search.html">

<!-- Used to display all of the print records belonging to a single user. -->
<dom-module id="view-user">
  <template>
      <user-search></user-search>
      <data-label size="65%" data="[[combineEmailAndSerial(email, serial)]]"></data-label>
      <data-label size="25%" data="[[printCount]]"></data-label>

    <template is="dom-repeat" items="{{data}}">
        <view-print data ='{{item}}'></view-print>
    </template>
  </template>

  <script>
      Polymer({
          is: 'view-user',

          properties: {
              data: Object,
              serial: Number,
              printCount: Object,
              email: {
                  type: String,
                  computed: 'lookupEmail(hasEmail, serial)' // makes this.email read-only
              },
              hasEmail: {
                  type: Boolean,
                  value: false
              },
              _email: String    // Used to store the email address, since this.email is read-only
          },

          lookupEmail: function(hasEmail, serial){
              if (hasEmail == false){
                  Meteor.call('findUserEmail', serial, (err, result) => {
                      this._email = result;
                      this.hasEmail = true;
                      console.log(this._email);
                  });
              }
              return this._email;
          },

          combineEmailAndSerial: function(email, serial){
              email = this.lookupEmail(this.hasEmail, serial);
              return [{ "email": email}, {"serial": serial} ];
          },

          attached: function(){
              Meteor.call('findUserData', this.serial, (err, result) => {
                  this.data = result;
                  this.printCount = [{"prints": this.data.length}];
              });
          }
      });
  </script>
</dom-module>
